<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrismSSL Research Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
</head>
<body>
    <header class="page-header">
        <div>
            <h1>PrismSSL Research Console</h1>
            <p>A minimal workspace for curating datasets and preparing training parameters.</p>
        </div>
        <div class="header-actions">
            <button id="export-config" type="button" class="ghost">Export JSON</button>
            <label class="ghost" for="import-config">
                <input type="file" id="import-config" accept="application/json" hidden>
                Import JSON
            </label>
            <button id="theme-toggle" type="button" class="ghost" aria-label="Toggle theme">Light</button>
        </div>
    </header>

    <main class="page">
        <section class="column">
            <article class="panel">
                <header class="panel-header">
                    <div>
                        <h2>Dataset Definition</h2>
                        <p>Paste your dataset implementation and select the class you intend to use.</p>
                    </div>
                </header>
                <label class="field">
                    <span>Dataset source code</span>
                    <textarea id="dataset-code" rows="16" placeholder="# Paste the dataset class definition here"></textarea>
                </label>
                <div class="cluster">
                    <button id="detect-dataset" type="button" class="primary">Detect classes</button>
                    <button id="clear-dataset" type="button" class="ghost">Clear</button>
                </div>
                <label class="field">
                    <span>Available classes</span>
                    <select id="dataset-class">
                        <option value="" disabled selected>Select a class</option>
                    </select>
                </label>
                <details class="fieldset" open>
                    <summary>Training arguments (JSON)</summary>
                    <textarea id="dataset-kwargs-train" rows="4" placeholder='{"root": "./data", "split": "train"}'></textarea>
                </details>
                <details class="fieldset">
                    <summary>Validation arguments (JSON)</summary>
                    <textarea id="dataset-kwargs-val" rows="3" placeholder='{"split": "val"}'></textarea>
                </details>
                <details class="fieldset">
                    <summary>Test arguments (JSON)</summary>
                    <textarea id="dataset-kwargs-test" rows="3" placeholder='{"split": "test"}'></textarea>
                </details>
                <button id="instantiate-dataset" type="button" class="secondary full">Preview dataset summary</button>
                <div id="dataset-summary" class="summary"></div>
            </article>
        </section>

        <section class="column">
            <article class="panel">
                <header class="panel-header">
                    <div>
                        <h2>Trainer specification</h2>
                        <p>Choose the modality and configure trainer options required for execution.</p>
                    </div>
                </header>
                <div class="grid">
                    <label class="field">
                        <span>Modality</span>
                        <select id="modality" required>
                            <option value="" disabled selected>Select</option>
                            <option value="audio">Audio</option>
                            <option value="vision">Vision</option>
                            <option value="graph">Graph</option>
                            <option value="multimodal">Multimodal</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Method</span>
                        <input id="method" type="text" placeholder="ssl_method" required>
                    </label>
                    <label class="field">
                        <span>Variant</span>
                        <input id="variant" type="text" value="base">
                    </label>
                    <label class="field">
                        <span>Checkpoint interval</span>
                        <input id="checkpoint_interval" type="number" min="1" value="10">
                    </label>
                    <label class="field">
                        <span>Save directory</span>
                        <input id="save_dir" type="text" value="./checkpoints">
                    </label>
                    <label class="field">
                        <span>Data loader workers</span>
                        <input id="num_workers" type="number" min="0" placeholder="Auto">
                    </label>
                </div>
                <div class="checks">
                    <label><input type="checkbox" id="reload_checkpoint"> Reload checkpoint</label>
                    <label><input type="checkbox" id="verbose" checked> Verbose logging</label>
                    <label><input type="checkbox" id="mixed_precision_training" checked> Mixed precision</label>
                    <label><input type="checkbox" id="use_data_parallel"> Data parallel</label>
                </div>
                <details class="fieldset">
                    <summary>Weights &amp; Biases</summary>
                    <div class="grid">
                        <label class="field">
                            <span>Project</span>
                            <input id="wandb_project" type="text" placeholder="prism-ssl">
                        </label>
                        <label class="field">
                            <span>Entity</span>
                            <input id="wandb_entity" type="text" placeholder="team">
                        </label>
                        <label class="field">
                            <span>Run name</span>
                            <input id="wandb_run_name" type="text" placeholder="experiment-01">
                        </label>
                        <label class="field">
                            <span>Mode</span>
                            <select id="wandb_mode">
                                <option value="online">online</option>
                                <option value="offline">offline</option>
                                <option value="disabled">disabled</option>
                            </select>
                        </label>
                    </div>
                    <label class="field">
                        <span>Notes</span>
                        <textarea id="wandb_notes" rows="2"></textarea>
                    </label>
                    <label class="field">
                        <span>Tags (comma separated)</span>
                        <input id="wandb_tags" type="text" placeholder="baseline,ssl">
                    </label>
                    <label class="field">
                        <span>Advanced configuration</span>
                        <textarea id="wandb_config" rows="3" placeholder='{"lr": 1e-4}'></textarea>
                    </label>
                </details>
                <details class="fieldset">
                    <summary>GenericSSL (optional)</summary>
                    <label class="toggle"><input type="checkbox" id="use_generic"> Enable generic trainer</label>
                    <div id="generic-settings" class="grid" hidden>
                        <label class="field">
                            <span>Model name</span>
                            <input id="generic_model_name" type="text" value="bert-base-uncased">
                        </label>
                        <label class="field">
                            <span>Epochs</span>
                            <input id="generic_epochs" type="number" min="1" value="10">
                        </label>
                        <label class="field">
                            <span>Use LoRA</span>
                            <input id="generic_use_lora" type="checkbox" checked>
                        </label>
                    </div>
                </details>
            </article>

            <article class="panel">
                <header class="panel-header">
                    <div>
                        <h2>Training schedule</h2>
                        <p>Define the optimisation routine that will be executed in the terminal.</p>
                    </div>
                </header>
                <div class="grid">
                    <label class="field">
                        <span>Batch size</span>
                        <input id="batch_size" type="number" min="1" value="16">
                    </label>
                    <label class="field">
                        <span>Epochs</span>
                        <input id="epochs" type="number" min="1" value="100">
                    </label>
                    <label class="field">
                        <span>Learning rate</span>
                        <input id="learning_rate" type="number" step="any" min="0" value="0.0001">
                    </label>
                    <label class="field">
                        <span>Weight decay</span>
                        <input id="weight_decay" type="number" step="any" min="0" value="0.01">
                    </label>
                    <label class="field">
                        <span>Optimizer</span>
                        <select id="optimizer">
                            <option value="adamw" selected>AdamW</option>
                            <option value="adam">Adam</option>
                            <option value="sgd">SGD</option>
                            <option value="lamb">LAMB</option>
                        </select>
                    </label>
                    <label class="field">
                        <span>Start epoch</span>
                        <input id="start_epoch" type="number" min="0" value="0">
                    </label>
                    <label class="field">
                        <span>Start iteration</span>
                        <input id="start_iteration" type="number" min="0" value="0">
                    </label>
                    <label class="field">
                        <span>Extra arguments (JSON)</span>
                        <textarea id="train_kwargs" rows="3" placeholder='{"gradient_clip": 1.0}'></textarea>
                    </label>
                </div>
                <div class="checks">
                    <label><input type="checkbox" id="use_hpo"> Enable hyper-parameter search</label>
                    <label><input type="checkbox" id="use_embedding_logger"> Log embeddings</label>
                </div>
                <div class="grid">
                    <label class="field">
                        <span>HPO trials</span>
                        <input id="n_trials" type="number" min="1" value="20">
                    </label>
                    <label class="field">
                        <span>Tuning epochs</span>
                        <input id="tuning_epochs" type="number" min="1" value="5">
                    </label>
                </div>
            </article>

            <article class="panel">
                <header class="panel-header">
                    <div>
                        <h2>Evaluation template</h2>
                        <p>Optional settings for downstream evaluation once training has finished.</p>
                    </div>
                </header>
                <label class="toggle"><input type="checkbox" id="include-eval" checked> Include evaluation parameters</label>
                <div id="evaluation-fields" class="grid">
                    <label class="field">
                        <span>Classes</span>
                        <input id="eval_num_classes" type="number" min="1" value="10">
                    </label>
                    <label class="field">
                        <span>Batch size</span>
                        <input id="eval_batch_size" type="number" min="1" value="64">
                    </label>
                    <label class="field">
                        <span>Learning rate</span>
                        <input id="eval_lr" type="number" step="any" min="0" value="0.001">
                    </label>
                    <label class="field">
                        <span>Epochs</span>
                        <input id="eval_epochs" type="number" min="1" value="10">
                    </label>
                    <label class="field">
                        <span>Freeze backbone</span>
                        <input id="eval_freeze_backbone" type="checkbox" checked>
                    </label>
                    <label class="field">
                        <span>Extra arguments (JSON)</span>
                        <textarea id="eval_kwargs" rows="3" placeholder='{"dropout": 0.2}'></textarea>
                    </label>
                </div>
            </article>
        </section>
    </main>

    <section class="preview">
        <div class="preview-header">
            <div>
                <h2>Run sheet</h2>
                <p>Validate inputs and export a structured configuration for terminal execution.</p>
            </div>
            <div class="preview-actions">
                <button id="generate-run-sheet" type="button" class="primary">Generate preview</button>
                <button
                    id="start-pretext-training"
                    type="button"
                    class="secondary"
                    data-label-idle="Start pretext training"
                    data-label-running="Training…"
                >
                    Start pretext training
                </button>
            </div>
        </div>
        <div id="message-area" role="status" aria-live="polite"></div>
        <pre id="config-preview" class="config-preview" aria-label="Configuration preview">{\n  "trainer": {},\n  "train": {},\n  "dataset": {}\n}</pre>
    </section>

    <footer class="page-footer">
        <p>Prepared configurations are intended to be executed manually in the PrismSSL training scripts.</p>
    </footer>
</body>
</html>
